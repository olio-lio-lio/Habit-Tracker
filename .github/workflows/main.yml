name: Lint, Audit and Deploy

permissions:
  contents: write        # Needed for git push
  pages: write           # Needed for deployment
  id-token: write

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout with full history (required for pushing)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Node setup
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Lint
      - name: Run ESLint
        run: npm run lint --if-present

      # Audit security
      - name: Run npm audit --fix
        run: npm audit fix || true

      # Configure Git so commits work
      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Commit only if there are changes (prevents exit code 128)
      - name: Commit changes if any
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: auto lint & audit fixes"
            git push origin main
          else
            echo "No changes to commit"
          fi

      # Build your site (your project is static, so no build command needed)
      - name: Prepare site
        run: |
          mkdir -p ./public
          cp -r index.html App.js styles.css ./public/

      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

   deploy:
    needs: build
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4


    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
